{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HouseMatch | Mapa de Propiedades</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#136dec",
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"]
                },
            },
        },
    }
</script>

<style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; }

    .glass-panel {
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(19,109,236,0.12);
    }
    .smoke-particle {
        position: fixed;
        pointer-events: none;
        background: radial-gradient(circle, rgba(19,109,236,0.1) 0%, rgba(255,255,255,0) 70%);
        border-radius: 50%;
        transform: translate(-50%,-50%);
        z-index: 9999;
        animation: dissipate 1.2s ease-out forwards;
        mix-blend-mode: multiply;
    }
    @keyframes dissipate {
        0%   { opacity: 0.5; transform: translate(-50%,-50%) scale(0.5); }
        100% { opacity: 0;   transform: translate(-50%,-50%) scale(3); }
    }

    /* Leaflet popup overrides */
    .leaflet-popup-content-wrapper {
        padding: 0 !important;
        border-radius: 1.5rem !important;
        overflow: hidden;
        border: none !important;
        box-shadow: 0 30px 60px -12px rgba(0,0,0,0.18),
                    0 18px 36px -18px rgba(0,0,0,0.2),
                    0 0 0 1px rgba(19,109,236,0.1) !important;
    }
    .leaflet-popup-content { margin: 0 !important; width: 288px !important; }
    .leaflet-popup-tip { background: white !important; }
    .leaflet-container { font-family: 'Inter', sans-serif; }

    /* Custom marker */
    .hm-marker {
        width: 44px; height: 44px;
        background: #136dec;
        border-radius: 50%;
        border: 3px solid white;
        display: flex; align-items: center; justify-content: center;
        color: white;
        box-shadow: 0 8px 20px rgba(19,109,236,0.35);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hm-marker:hover {
        transform: scale(1.12);
        box-shadow: 0 12px 28px rgba(19,109,236,0.45);
    }

    /* Toggle switch */
    .sw-track { transition: background-color 0.2s ease; }
    .sw-thumb  { transition: transform 0.2s ease; }
    .sw-track.on  { background-color: #136dec; }
    .sw-thumb.on  { transform: translateX(20px); }

    /* Bedroom / bathroom selector */
    .selector-btn { transition: all 0.15s ease; }
    .selector-btn.active {
        background: #136dec; color: white;
        border-color: #136dec;
        box-shadow: 0 4px 12px rgba(19,109,236,0.25);
    }

    /* Multi-select transaction type */
    .tt-checkbox:checked + label {
        background-color: #136dec !important;
        color: white !important;
        border-color: #136dec !important;
        box-shadow: 0 4px 12px rgba(19,109,236,0.2);
    }

    #map { position: absolute; inset: 0; }
</style>
</head>

<body class="bg-white text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

<!-- Smoke cursor -->
<script>
    document.addEventListener('mousemove', function(e) {
        if (Math.random() > 0.85) return;
        const p = document.createElement('div');
        p.classList.add('smoke-particle');
        const s = Math.random() * 60 + 30;
        p.style.cssText = `width:${s}px;height:${s}px;left:${e.clientX}px;top:${e.clientY}px`;
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1200);
    });
</script>

<!-- â”€â”€ Navbar â”€â”€ -->
<nav class="bg-white border-b border-slate-100 z-50 flex-shrink-0 shadow-sm">
    <div class="max-w-[1920px] mx-auto px-4 lg:px-6 h-16 flex items-center justify-between">
        <a href="{% url 'home:index' %}" class="flex items-center gap-2 group">
            <img src="{% static 'home/img/Logo.png' %}" alt="HouseMatch Logo" class="h-8 w-auto">
            <span class="text-xl font-extrabold tracking-tight text-slate-900">HouseMatch</span>
        </a>

        <div class="flex items-center gap-4">
            <a href="/tools/acm/" class="px-3 py-1.5 rounded-xl text-xs font-bold border border-slate-200 text-slate-600 hover:border-[#136dec] hover:text-[#136dec] transition-all">ACM</a>
            <button class="px-3 py-1.5 rounded-xl text-xs font-bold border border-slate-200 text-slate-600 hover:border-[#136dec] hover:text-[#136dec] transition-all">Datos</button>
            {% if user.is_authenticated %}
            <a id="nav-heart-link"
               href="{% url 'home:etiquetas' %}"
               title="Mis etiquetas guardadas"
               class="flex items-center justify-center hover:scale-110 transition-transform"
               style="color:#e11d48;line-height:1">
                <span class="material-icons" style="font-size:22px">favorite</span>
            </a>
            {% endif %}

            {% if user.is_authenticated %}
            <a href="{% url 'home:logout' %}"
               class="text-slate-500 hover:text-slate-800 font-medium text-sm transition-colors">
                Salir
            </a>
            <div class="w-10 h-10 rounded-full bg-[#136dec] flex items-center justify-center text-white font-bold text-sm shadow-sm cursor-default select-none">
                {{ user.email|first|upper }}
            </div>
            {% else %}
            <a href="{% url 'home:login' %}"
               class="px-4 py-2 bg-[#136dec] text-white rounded-full font-semibold text-sm shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition-colors">
                Iniciar sesiÃ³n
            </a>
            {% endif %}
        </div>
    </div>
</nav>

<!-- â”€â”€ Search & Filters â”€â”€ -->
<header class="bg-white border-b border-slate-100 z-40 shadow-[0_1px_3px_rgba(0,0,0,0.03)] flex-shrink-0">
    <div class="max-w-[1920px] mx-auto px-4 lg:px-6 py-2">
        <div class="flex flex-wrap items-center gap-2">

            <!-- Search -->
            <div class="flex-1 min-w-[220px] relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-lg">search</span>
                <input id="search-input"
                       type="text"
                       placeholder="Buscar zona, ciudad, tÃ­tulo..."
                       class="w-full pl-9 pr-3 py-2 rounded-xl border border-slate-200 bg-slate-50/50 focus:bg-white focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none transition-all text-sm font-medium"/>
            </div>

            <!-- Transaction type -->
            <div class="flex items-center gap-1.5">
                <div class="relative">
                    <input type="checkbox" id="tt-alquiler" class="tt-checkbox hidden" checked/>
                    <label for="tt-alquiler" class="px-3 py-1.5 rounded-xl text-xs font-bold uppercase tracking-wider cursor-pointer transition-all border-2 border-slate-200 text-slate-500 bg-white hover:border-blue-300 block">Alquiler</label>
                </div>
                <div class="relative">
                    <input type="checkbox" id="tt-venta" class="tt-checkbox hidden" checked/>
                    <label for="tt-venta" class="px-3 py-1.5 rounded-xl text-xs font-bold uppercase tracking-wider cursor-pointer transition-all border-2 border-slate-200 text-slate-500 bg-white hover:border-blue-300 block">Venta</label>
                </div>
                <div class="relative">
                    <input type="checkbox" id="tt-anticretico" class="tt-checkbox hidden" checked/>
                    <label for="tt-anticretico" class="px-3 py-1.5 rounded-xl text-xs font-bold uppercase tracking-wider cursor-pointer transition-all border-2 border-slate-200 text-slate-500 bg-white hover:border-blue-300 block">Anticretico</label>
                </div>
            </div>

            <!-- Price range -->
            <div class="flex items-center bg-slate-50/50 border border-slate-200 rounded-xl overflow-hidden">
                <div class="flex items-center px-3 gap-1.5 py-2">
                    <span class="text-[10px] font-black text-slate-400 tracking-tighter">MIN $</span>
                    <input id="price-min" type="number" min="0" placeholder="0"
                           class="w-16 bg-transparent border-none focus:ring-0 outline-none p-0 text-sm font-bold text-slate-700"/>
                </div>
                <div class="h-5 w-px bg-slate-200"></div>
                <div class="flex items-center px-3 gap-1.5 py-2">
                    <span class="text-[10px] font-black text-slate-400 tracking-tighter">MAX $</span>
                    <input id="price-max" type="number" min="0" placeholder="Cualquiera"
                           class="w-20 bg-transparent border-none focus:ring-0 outline-none p-0 text-sm font-bold text-slate-700"/>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center gap-2">
                <button onclick="toggleAdvanced()"
                        class="flex items-center gap-1.5 px-3 py-2 bg-white border border-slate-200 rounded-xl text-slate-700 font-bold text-sm hover:border-[#136dec] hover:text-[#136dec] transition-all">
                    <span class="material-symbols-outlined text-lg">tune</span>
                    Filtros
                </button>
                <button id="btn-radio" onclick="toggleRadiusMode()"
                        class="flex items-center gap-1.5 px-3 py-2 bg-white border border-slate-200 rounded-xl text-slate-700 font-bold text-sm hover:border-[#136dec] hover:text-[#136dec] transition-all">
                    <span class="material-symbols-outlined text-lg">my_location</span>
                    Radio
                </button>
                <button onclick="applyFilters()"
                        class="flex items-center gap-1.5 px-5 py-2 bg-[#136dec] text-white font-bold text-sm rounded-xl shadow-lg shadow-blue-500/20 hover:shadow-blue-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all">
                    <span class="material-symbols-outlined text-lg">search</span>
                    Ver resultados
                </button>
            </div>
        </div>

        <!-- Advanced panel -->
        <div id="advanced-panel" class="hidden mt-2 pt-2 border-t border-slate-100">
            <div class="flex flex-wrap items-center gap-4">

                <!-- Bedrooms -->
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cuartos</span>
                    <div class="flex gap-1" id="rooms-group">
                        <button onclick="selectBtn(this,'rooms',0)" class="selector-btn active w-8 h-8 rounded-lg border-2 border-[#136dec] bg-[#136dec] text-white flex items-center justify-center font-bold text-xs">â€”</button>
                        <button onclick="selectBtn(this,'rooms',1)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">1+</button>
                        <button onclick="selectBtn(this,'rooms',2)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">2+</button>
                        <button onclick="selectBtn(this,'rooms',3)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">3+</button>
                        <button onclick="selectBtn(this,'rooms',4)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">4+</button>
                    </div>
                </div>

                <div class="h-5 w-px bg-slate-200"></div>

                <!-- Bathrooms -->
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">BaÃ±os</span>
                    <div class="flex gap-1" id="baths-group">
                        <button onclick="selectBtn(this,'baths',0)" class="selector-btn active w-8 h-8 rounded-lg border-2 border-[#136dec] bg-[#136dec] text-white flex items-center justify-center font-bold text-xs">â€”</button>
                        <button onclick="selectBtn(this,'baths',1)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">1+</button>
                        <button onclick="selectBtn(this,'baths',2)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">2+</button>
                        <button onclick="selectBtn(this,'baths',3)" class="selector-btn w-8 h-8 rounded-lg border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs hover:border-[#136dec] hover:text-[#136dec]">3+</button>
                    </div>
                </div>

                <div class="h-5 w-px bg-slate-200"></div>

                <!-- Amenities toggles -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <button id="sw-piscina" onclick="toggleAmenity('piscina')"
                                class="sw-track relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none bg-slate-200">
                            <span id="th-piscina" class="sw-thumb inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0"></span>
                        </button>
                        <span class="text-xs font-bold text-slate-600">Piscina</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="sw-parqueo" onclick="toggleAmenity('parqueo')"
                                class="sw-track relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none bg-slate-200">
                            <span id="th-parqueo" class="sw-thumb inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0"></span>
                        </button>
                        <span class="text-xs font-bold text-slate-600">Parqueo</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="sw-mascotas" onclick="toggleAmenity('mascotas')"
                                class="sw-track relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent focus:outline-none bg-slate-200">
                            <span id="th-mascotas" class="sw-thumb inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0"></span>
                        </button>
                        <span class="text-xs font-bold text-slate-600">Mascotas</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</header>

<!-- â”€â”€ Map â”€â”€ -->
<main class="flex-1 relative overflow-hidden">
    <div id="map"></div>

    <!-- Empty state overlay -->
    <div id="map-empty-msg"
         class="absolute inset-0 flex items-center justify-center z-[400] pointer-events-none">
      <div class="bg-white/80 backdrop-blur rounded-xl px-6 py-4 text-center shadow">
        <span class="material-icons text-4xl text-gray-400">map</span>
        <p class="text-gray-600 mt-1 text-sm font-medium">
          Usa los filtros para buscar propiedades
        </p>
      </div>
    </div>

    <!-- Radius panel -->
    <div id="radius-panel" style="display:none"
         class="absolute bottom-24 left-1/2 -translate-x-1/2 z-[500] glass-panel rounded-2xl shadow-2xl px-5 py-4
                flex flex-col items-center gap-3 min-w-[260px]">

        <!-- State A: no center placed yet -->
        <div id="radius-hint" class="flex items-center gap-2 text-sm font-semibold text-slate-600">
            <span class="material-symbols-outlined text-[#136dec]">ads_click</span>
            Haz clic en el mapa para colocar el centro
        </div>

        <!-- State B: center placed -->
        <div id="radius-controls" style="display:none" class="flex flex-col items-center gap-3 w-full">
            <div class="flex items-center justify-between w-full">
                <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Radio</span>
                <span id="radius-label" class="text-sm font-black text-[#136dec]">2.0 km</span>
            </div>
            <input id="radius-slider" type="range" min="500" max="20000" step="100" value="2000"
                   class="w-full accent-[#136dec]" oninput="onRadiusSlide(this.value)"/>
            <div class="flex gap-2 w-full">
                <button onclick="applyFilters()"
                        class="flex-1 py-2 bg-[#136dec] text-white font-bold text-sm rounded-xl
                               shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition-colors">
                    Buscar aquÃ­
                </button>
                <button onclick="exitRadiusMode()"
                        class="px-4 py-2 border border-slate-200 text-slate-600 font-bold text-sm
                               rounded-xl hover:border-slate-400 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Zoom controls -->
    <div class="absolute bottom-10 left-10 flex flex-col gap-3 z-[400]">
        <button onclick="mapInst.zoomIn()"
                class="w-12 h-12 bg-white rounded-2xl shadow-xl border border-slate-100 flex items-center justify-center text-slate-600 hover:text-[#136dec] hover:scale-105 active:scale-95 transition-all">
            <span class="material-symbols-outlined">add</span>
        </button>
        <button onclick="mapInst.zoomOut()"
                class="w-12 h-12 bg-white rounded-2xl shadow-xl border border-slate-100 flex items-center justify-center text-slate-600 hover:text-[#136dec] hover:scale-105 active:scale-95 transition-all">
            <span class="material-symbols-outlined">remove</span>
        </button>
    </div>

    <!-- Locate / recenter button -->
    <div class="absolute bottom-10 right-10 z-[400]">
        <button onclick="centerBolivia()"
                class="flex items-center gap-2 px-8 py-4 bg-white rounded-full shadow-2xl border border-slate-100 text-slate-700 font-bold hover:bg-slate-50 hover:scale-105 active:scale-95 transition-all group">
            <span class="material-symbols-outlined text-[#136dec] group-hover:rotate-12 transition-transform">my_location</span>
            Centrar en Bolivia
        </button>
    </div>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// â”€â”€ Auth flag (set by Django template) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IS_AUTHENTICATED = {% if user.is_authenticated %}true{% else %}false{% endif %};

// â”€â”€ Map init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SANTA_CRUZ = [-17.7833, -63.1821];
const mapInst = L.map('map', { zoomControl: false }).setView(SANTA_CRUZ, 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a>'
}).addTo(mapInst);

// â”€â”€ Radius mode: handle map clicks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mapInst.on('click', function(e) {
    if (!radiusMode) return;
    placeRadiusCenter(e.latlng);
});

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allFeatures  = [];
let activeLayer  = null;
let clusterGroup = null;
let minRooms     = 0;
let minBaths     = 0;
const amenState  = { piscina: false, parqueo: false, mascotas: false };

// â”€â”€ Radius mode state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let radiusMode   = false;
let radiusCenter = null;   // L.LatLng
let radiusMeters = 2000;   // default 2 km
let radiusCircle = null;   // L.Circle
let radiusMarker = null;   // L.Marker draggable

// â”€â”€ Marker icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ICON_MAP = { 'Casa': 'house', 'Dpto': 'apartment', 'Quinta': 'nature_people' };

function makeIcon(tipo) {
    const name = ICON_MAP[tipo] || 'home';
    return L.divIcon({
        html: `<div class="hm-marker"><span class="material-icons" style="font-size:20px">${name}</span></div>`,
        className: '',
        iconSize:   [44, 44],
        iconAnchor: [22, 22],
        popupAnchor:[0, -26],
    });
}

// â”€â”€ Popup HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function popupHtml(p) {
    const imgHtml = p.imagen_principal
        ? `<img src="${p.imagen_principal}" alt="${p.titulo}"
               style="width:100%;height:100%;object-fit:cover;display:block"/>`
        : `<div style="width:100%;height:100%;background:#f1f5f9;display:flex;align-items:center;justify-content:center">
               <span class="material-icons" style="font-size:48px;color:#cbd5e1">home</span>
           </div>`;

    const badge = `<a href="/inmuebles/${p.id}/" target="_blank" rel="noopener"
        style="position:absolute;top:12px;right:12px;background:#136dec;color:white;
               font-size:10px;font-weight:900;padding:6px 12px;border-radius:12px;
               text-decoration:none;box-shadow:0 4px 12px rgba(19,109,236,0.3)">
        VER DETALLE
    </a>`;

    const heartBtn = IS_AUTHENTICATED
        ? `<button data-heart="${p.id}"
               style="position:absolute;top:10px;left:12px;background:rgba(255,255,255,0.92);
                      border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;
                      display:flex;align-items:center;justify-content:center;
                      box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:0">
               <span class="material-icons" style="font-size:18px;color:#e11d48">favorite_border</span>
           </button>`
        : '';

    const amenIcons = [
        p.piscina         ? 'ğŸŠ' : '',
        p.parqueo         ? 'ğŸš—' : '',
        p.permite_mascotas? 'ğŸ¾' : '',
    ].filter(Boolean).join(' ');

    return `
    <div style="width:288px;font-family:'Inter',sans-serif;">
        <div style="position:relative;height:176px;overflow:hidden;">
            ${imgHtml}
            <div style="position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.4) 0%,transparent 60%)"></div>
            ${badge}
            ${heartBtn}
        </div>
        <div style="padding:20px;">
            <p style="margin:0 0 4px;font-size:1.05rem;font-weight:800;color:#136dec;line-height:1.3">${p.titulo}</p>
            <p style="margin:0 0 14px;font-size:0.75rem;color:#64748b;display:flex;align-items:center;gap:4px">
                <span class="material-symbols-outlined" style="font-size:14px">location_on</span>
                ${p.zona}, ${p.ciudad}
            </p>
            <div style="display:flex;align-items:center;justify-content:space-between;padding-top:14px;border-top:1px solid #f1f5f9">
                <div>
                    <div style="font-size:1.2rem;font-weight:900;color:#1e293b;letter-spacing:-0.02em;line-height:1.2">
                        $${Number(p.precio_usd).toLocaleString()} <span style="font-size:0.65rem;font-weight:700;color:#94a3b8">USD</span>
                    </div>
                    <div style="font-size:0.78rem;font-weight:700;color:#64748b;line-height:1.2">
                        Bs ${Number(p.precio_bs).toLocaleString()}
                    </div>
                </div>
                <div style="display:flex;gap:10px;background:#f8fafc;padding:5px 12px;border-radius:999px;border:1px solid #f1f5f9;font-size:0.75rem;font-weight:700;color:#475569;align-items:center">
                    <span style="display:flex;align-items:center;gap:3px">
                        <span class="material-symbols-outlined" style="font-size:15px;color:#136dec">bed</span>${p.cant_cuartos ?? 'â€”'}
                    </span>
                    <span style="display:flex;align-items:center;gap:3px">
                        <span class="material-symbols-outlined" style="font-size:15px;color:#136dec">bathtub</span>${p.cant_banios ?? 'â€”'}
                    </span>
                    ${amenIcons ? `<span style="letter-spacing:2px">${amenIcons}</span>` : ''}
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;font-size:0.72rem;font-weight:700;color:#64748b">
                ${parseFloat(p.area_construida) > 0 ? `<span style="display:flex;align-items:center;gap:3px;background:#f1f5f9;padding:3px 9px;border-radius:999px"><span class="material-symbols-outlined" style="font-size:13px;color:#136dec">house</span>${parseFloat(p.area_construida)} mÂ² const.</span>` : ''}
                ${parseFloat(p.area_terreno) > 0 ? `<span style="display:flex;align-items:center;gap:3px;background:#f1f5f9;padding:3px 9px;border-radius:999px"><span class="material-symbols-outlined" style="font-size:13px;color:#136dec">landscape</span>${parseFloat(p.area_terreno)} mÂ² terreno</span>` : ''}
            </div>
        </div>
    </div>`;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(features) {
    if (clusterGroup) { mapInst.removeLayer(clusterGroup); clusterGroup = null; }
    if (activeLayer)  { mapInst.removeLayer(activeLayer);  activeLayer  = null; }

    const emptyMsg = document.getElementById('map-empty-msg');
    if (emptyMsg) emptyMsg.style.display = features.length === 0 ? 'flex' : 'none';
    if (!features.length) return;

    clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            let color, size;
            if (count < 10)       { color = '#93c5fd'; size = 32; }
            else if (count < 50)  { color = '#136dec'; size = 42; }
            else                  { color = '#1e3a8a'; size = 52; }
            return L.divIcon({
                html: `<div style="width:${size}px;height:${size}px;background:${color};border-radius:50%;border:3px solid rgba(255,255,255,0.8);box-shadow:0 2px 6px rgba(0,0,0,0.25);"></div>`,
                className: '',
                iconSize:   [size, size],
                iconAnchor: [size/2, size/2],
            });
        },
    });

    activeLayer = L.geoJSON(
        { type: 'FeatureCollection', features },
        {
            pointToLayer: (f, ll) => L.marker(ll, { icon: makeIcon(f.properties.tipo_propiedad) }),
            onEachFeature: (f, m) => m.bindPopup(popupHtml(f.properties), { maxWidth: 310 }),
        }
    );

    clusterGroup.addLayer(activeLayer);
    mapInst.addLayer(clusterGroup);

    const b = activeLayer.getBounds();
    if (b.isValid()) mapInst.fitBounds(b, { padding: [60, 60] });
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
    const q        = document.getElementById('search-input').value.toLowerCase().trim();
    const minP     = parseFloat(document.getElementById('price-min').value) || 0;
    const maxP     = parseFloat(document.getElementById('price-max').value) || Infinity;
    const wAlq     = document.getElementById('tt-alquiler').checked;
    const wVen     = document.getElementById('tt-venta').checked;
    const wAnti    = document.getElementById('tt-anticretico').checked;

    let filtered = allFeatures.filter(f => {
        const p    = f.properties;

        // Text search â€” skip when radius mode is active
        if (!radiusMode) {
            const text = `${p.titulo} ${p.zona} ${p.ciudad} ${p.calle}`.toLowerCase();
            const words = q.split(/\s+/).filter(Boolean);
            if (words.length > 0 && !words.every(w => text.includes(w))) return false;
        }

        const price = parseFloat(p.precio_usd);
        if (price < minP || price > maxP) return false;

        const tt = (p.tipo_transaccion || '').toLowerCase();
        if (tt.includes('alquiler')    && !wAlq)  return false;
        if (tt.includes('venta')       && !wVen)  return false;
        if (tt.includes('anticretico') && !wAnti) return false;

        if (minRooms > 0 && (p.cant_cuartos ?? 0) < minRooms) return false;
        if (minBaths > 0 && (p.cant_banios  ?? 0) < minBaths) return false;

        if (amenState.piscina   && !p.piscina)          return false;
        if (amenState.parqueo   && !p.parqueo)           return false;
        if (amenState.mascotas  && !p.permite_mascotas)  return false;

        return true;
    });

    // Radius filter
    if (radiusMode && radiusCenter) {
        filtered = filtered.filter(f => {
            const ll = L.latLng(
                f.geometry.coordinates[1],
                f.geometry.coordinates[0]
            );
            return radiusCenter.distanceTo(ll) <= radiusMeters;
        });
    }

    render(filtered);
}

// â”€â”€ Radius mode functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRadiusMode() {
    radiusMode ? exitRadiusMode() : enterRadiusMode();
}

function enterRadiusMode() {
    radiusMode = true;
    mapInst.getContainer().style.cursor = 'crosshair';
    document.getElementById('radius-panel').style.display = 'flex';
    document.getElementById('radius-hint').style.display = 'flex';
    document.getElementById('radius-controls').style.display = 'none';
    document.getElementById('btn-radio').classList.add('bg-[#136dec]', 'text-white', 'border-[#136dec]');
}

function exitRadiusMode() {
    radiusMode = false;
    radiusCenter = null;
    mapInst.getContainer().style.cursor = '';
    document.getElementById('radius-panel').style.display = 'none';
    if (radiusCircle) { mapInst.removeLayer(radiusCircle); radiusCircle = null; }
    if (radiusMarker) { mapInst.removeLayer(radiusMarker); radiusMarker = null; }
    document.getElementById('btn-radio').classList.remove('bg-[#136dec]', 'text-white', 'border-[#136dec]');
}

function placeRadiusCenter(latlng) {
    radiusCenter = latlng;

    if (radiusCircle) mapInst.removeLayer(radiusCircle);
    if (radiusMarker) mapInst.removeLayer(radiusMarker);

    radiusCircle = L.circle(latlng, {
        radius: radiusMeters,
        color: '#136dec', weight: 2, dashArray: '6 4',
        fillColor: '#136dec', fillOpacity: 0.12,
    }).addTo(mapInst);

    radiusMarker = L.marker(latlng, {
        draggable: true,
        icon: L.divIcon({
            html: `<div style="width:18px;height:18px;background:#136dec;border:3px solid white;
                               border-radius:50%;box-shadow:0 2px 8px rgba(19,109,236,0.5)"></div>`,
            className: '', iconSize: [18,18], iconAnchor: [9,9],
        })
    }).addTo(mapInst);

    radiusMarker.on('drag', function(e) {
        radiusCenter = e.latlng;
        radiusCircle.setLatLng(e.latlng);
    });
    radiusMarker.on('dragend', applyFilters);

    document.getElementById('radius-hint').style.display = 'none';
    document.getElementById('radius-controls').style.display = 'flex';
}

function onRadiusSlide(val) {
    radiusMeters = Number(val);
    const label = radiusMeters >= 1000
        ? (radiusMeters / 1000).toFixed(1) + ' km'
        : radiusMeters + ' m';
    document.getElementById('radius-label').textContent = label;
    if (radiusCircle) radiusCircle.setRadius(radiusMeters);
    applyFilters();
}

// â”€â”€ Data fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetch('/api/inmuebles/mapa/')
    .then(r => r.json())
    .then(geo => {
        allFeatures = geo.features || [];
        // No se llama render() â†’ mapa inicia vacÃ­o
    })
    .catch(() => {});

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAdvanced() {
    document.getElementById('advanced-panel').classList.toggle('hidden');
}

function selectBtn(btn, group, val) {
    if (group === 'rooms') minRooms = val;
    else                   minBaths = val;

    const id = group === 'rooms' ? 'rooms-group' : 'baths-group';
    document.querySelectorAll(`#${id} .selector-btn`).forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function toggleAmenity(name) {
    amenState[name] = !amenState[name];
    const track = document.getElementById(`sw-${name}`);
    const thumb = document.getElementById(`th-${name}`);
    if (amenState[name]) {
        track.classList.add('on');
        thumb.classList.add('on');
    } else {
        track.classList.remove('on');
        thumb.classList.remove('on');
    }
}

function centerBolivia() {
    mapInst.setView(SANTA_CRUZ, 12);
}

// â”€â”€ Match sound (Web Audio API, sin archivos externos) â”€â”€â”€â”€â”€â”€â”€â”€
let _journeyPlayed = false; // guard: evita doble reproducciÃ³n en crearYGuardar

function playJourneySound() {
    if (_journeyPlayed) return;
    _journeyPlayed = true;

    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;

    // Sweep de triÃ¡ngulo cÃ¡lido (suave, amigable â€” no sawtooth ni ruido)
    const sweep = ctx.createOscillator();
    const swGain = ctx.createGain();
    sweep.type = 'triangle';
    sweep.frequency.setValueAtTime(260, t);
    sweep.frequency.exponentialRampToValueAtTime(1300, t + 1.2);
    swGain.gain.setValueAtTime(0, t);
    swGain.gain.linearRampToValueAtTime(0.10, t + 0.06);
    swGain.gain.linearRampToValueAtTime(0.07, t + 0.95);
    swGain.gain.linearRampToValueAtTime(0, t + 1.2);
    sweep.connect(swGain);
    swGain.connect(ctx.destination);
    sweep.start(t);
    sweep.stop(t + 1.2);

    // Campanitas en arpeggio (C5 â†’ E5 â†’ G5) â€” sensaciÃ³n mÃ¡gica de vuelo
    [[0.12, 523.25, 0.28], [0.48, 659.25, 0.30], [0.84, 783.99, 0.32]].forEach(([delay, freq, vol]) => {
        const bell = ctx.createOscillator();
        const bg = ctx.createGain();
        bell.type = 'sine';
        bell.frequency.setValueAtTime(freq, t + delay);
        bg.gain.setValueAtTime(0, t + delay);
        bg.gain.linearRampToValueAtTime(vol, t + delay + 0.014);
        bg.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.48);
        bell.connect(bg);
        bg.connect(ctx.destination);
        bell.start(t + delay);
        bell.stop(t + delay + 0.52);
    });

    setTimeout(() => {
        _journeyPlayed = false;
        ctx.close();
    }, 1800);
}

function playExplosionSound() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;

    // 1) Bass thump (golpe bajo explosivo)
    const imp = ctx.createOscillator();
    const impG = ctx.createGain();
    imp.type = 'sine';
    imp.frequency.setValueAtTime(230, t);
    imp.frequency.exponentialRampToValueAtTime(32, t + 0.18);
    impG.gain.setValueAtTime(0, t);
    impG.gain.linearRampToValueAtTime(1.1, t + 0.007);
    impG.gain.exponentialRampToValueAtTime(0.001, t + 0.40);
    imp.connect(impG);
    impG.connect(ctx.destination);
    imp.start(t);
    imp.stop(t + 0.40);

    // 2) Noise burst (estallido)
    const eLen = Math.ceil(ctx.sampleRate * 0.45);
    const eBuf = ctx.createBuffer(1, eLen, ctx.sampleRate);
    const eData = eBuf.getChannelData(0);
    for (let i = 0; i < eLen; i++) eData[i] = Math.random() * 2 - 1;
    const eNode = ctx.createBufferSource();
    eNode.buffer = eBuf;
    const eFilter = ctx.createBiquadFilter();
    eFilter.type = 'lowpass';
    eFilter.frequency.setValueAtTime(5000, t);
    eFilter.frequency.exponentialRampToValueAtTime(280, t + 0.38);
    const eGain = ctx.createGain();
    eGain.gain.setValueAtTime(0.80, t);
    eGain.gain.exponentialRampToValueAtTime(0.001, t + 0.40);
    eNode.connect(eFilter);
    eFilter.connect(eGain);
    eGain.connect(ctx.destination);
    eNode.start(t);
    eNode.stop(t + 0.45);

    // 3) Sparkles escalonados (A5 â†’ E6 â†’ A6)
    [[0.02, 880, 0.52], [0.07, 1320, 0.46], [0.13, 1760, 0.36]].forEach(([delay, freq, vol]) => {
        const sp = ctx.createOscillator();
        const sg = ctx.createGain();
        sp.type = 'sine';
        sp.frequency.setValueAtTime(freq, t + delay);
        sg.gain.setValueAtTime(vol, t + delay);
        sg.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.72);
        sp.connect(sg);
        sg.connect(ctx.destination);
        sp.start(t + delay);
        sp.stop(t + delay + 0.75);
    });

    setTimeout(() => ctx.close(), 1800);
}

// â”€â”€ Flying heart animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flyHeartToNav() {
    const navHeart = document.getElementById('nav-heart-link');
    if (!navHeart) return;

    // Origin: centro del card del modal
    const modalCard = document.querySelector('#heart-modal > div');
    if (!modalCard) return;
    const fromRect = modalCard.getBoundingClientRect();
    const fromX = fromRect.left + fromRect.width  / 2;
    const fromY = fromRect.top  + fromRect.height / 2;

    // Destination: centro del Ã­cono de corazÃ³n en el navbar
    const toRect = navHeart.getBoundingClientRect();
    const toX = toRect.left + toRect.width  / 2;
    const toY = toRect.top  + toRect.height / 2;

    // Crear partÃ­cula voladora
    const el = document.createElement('div');
    el.style.cssText = `
        position:fixed;
        left:${fromX}px;
        top:${fromY}px;
        transform:translate(-50%,-50%);
        pointer-events:none;
        z-index:10000;
        font-size:28px;
        line-height:1;
        filter:drop-shadow(0 0 8px rgba(225,29,72,0.7));
        will-change:transform,opacity;
    `;
    el.textContent = 'â¤ï¸';
    document.body.appendChild(el);

    // Punto de arco (curva hacia arriba y a la derecha/izquierda)
    const midX = (fromX + toX) / 2 + (toX - fromX) * 0.15;
    const midY = Math.min(fromY, toY) - 80;  // arco hacia arriba

    // AnimaciÃ³n con Web Animations API (arco en 3 keyframes)
    const dx1 = midX - fromX;
    const dy1 = midY - fromY;
    const dx2 = toX  - fromX;
    const dy2 = toY  - fromY;

    const anim = el.animate([
        { transform: `translate(-50%,-50%) scale(1)`,    opacity: 1   },
        { transform: `translate(calc(-50% + ${dx1}px), calc(-50% + ${dy1}px)) scale(1.35)`, opacity: 1, offset: 0.45 },
        { transform: `translate(calc(-50% + ${dx2}px), calc(-50% + ${dy2}px)) scale(0.25)`, opacity: 0.85 },
    ], {
        duration: 1100,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
        fill: 'forwards',
    });

    // Al llegar: bounce en el Ã­cono del navbar + limpiar
    anim.onfinish = () => {
        el.remove();
        navHeart.animate([
            { transform: 'scale(1)'    },
            { transform: 'scale(2.4)', offset: 0.22 },
            { transform: 'scale(0.65)', offset: 0.48 },
            { transform: 'scale(1.6)', offset: 0.68 },
            { transform: 'scale(0.88)', offset: 0.85 },
            { transform: 'scale(1)'    },
        ], { duration: 520, easing: 'ease-out' });
    };
}

// â”€â”€ Heart modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCsrfToken() {
    return document.cookie.split(';')
        .map(c => c.trim())
        .find(c => c.startsWith('csrftoken='))
        ?.split('=')[1] ?? '';
}

let currentInmuebleId = null;

async function openHeartModal(inmuebleId) {
    currentInmuebleId = inmuebleId;
    const modal = document.getElementById('heart-modal');
    const feedback = document.getElementById('heart-feedback');
    feedback.textContent = '';
    feedback.style.color = '';
    document.getElementById('new-etiqueta-input').value = '';
    modal.style.display = 'flex';
    const card = modal.querySelector('div');
    card.style.transform = 'scale(0.95)';
    card.style.opacity = '0';
    card.style.transition = 'transform 0.18s ease,opacity 0.18s ease';
    requestAnimationFrame(() => {
        card.style.transform = 'scale(1)';
        card.style.opacity = '1';
    });

    try {
        const res = await fetch('/api/etiquetas/', {
            headers: { 'X-CSRFToken': getCsrfToken() }
        });
        if (!res.ok) throw new Error();
        const etiquetas = await res.json();
        renderEtiquetas(etiquetas);
    } catch {
        document.getElementById('heart-etiquetas-list').innerHTML =
            '<p style="color:#64748b;font-size:0.85rem">No se pudieron cargar las etiquetas.</p>';
    }
}

function renderEtiquetas(etiquetas) {
    const list = document.getElementById('heart-etiquetas-list');
    if (!etiquetas.length) {
        list.innerHTML = '<p style="color:#94a3b8;font-size:0.85rem;margin:0">Sin etiquetas aÃºn. Crea una abajo.</p>';
        return;
    }
    list.innerHTML = etiquetas.map(e => `
        <button onclick="guardarEnEtiqueta(${e.id})"
                style="display:flex;align-items:center;gap:8px;width:100%;text-align:left;
                       padding:9px 14px;border:1.5px solid #e2e8f0;border-radius:12px;
                       background:#f8fafc;font-family:'Inter',sans-serif;
                       font-size:0.875rem;font-weight:600;color:#334155;cursor:pointer;
                       transition:all 0.15s"
                onmouseover="this.style.borderColor='#136dec';this.style.background='#eff6ff';this.style.color='#136dec'"
                onmouseout="this.style.borderColor='#e2e8f0';this.style.background='#f8fafc';this.style.color='#334155'">
            <span class="material-icons" style="font-size:16px;color:#e11d48;flex-shrink:0">label</span>
            <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.nombre}</span>
        </button>`).join('');
}

async function guardarEnEtiqueta(etiquetaId) {
    playJourneySound();                              // â† inicia al instante del clic
    const feedback = document.getElementById('heart-feedback');
    try {
        const res = await fetch(`/api/etiquetas/${etiquetaId}/guardados/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ inmueble: currentInmuebleId }),
        });
        const data = await res.json();
        if (res.status === 201) {
            flyHeartToNav();                         // â† animaciÃ³n
            playExplosionSound();                    // â† sonido de impacto
            feedback.textContent = 'Â¡Guardado correctamente!';
            feedback.style.color = '#16a34a';
            setTimeout(closeHeartModal, 1200);
        } else {
            const msg = typeof data === 'object' ? Object.values(data).flat().join(' ') : 'Error al guardar.';
            feedback.textContent = msg;
            feedback.style.color = '#dc2626';
        }
    } catch {
        feedback.textContent = 'Error de conexiÃ³n.';
        feedback.style.color = '#dc2626';
    }
}

async function crearYGuardar() {
    playJourneySound();                              // â† inicia al instante del clic
    const input = document.getElementById('new-etiqueta-input');
    const nombre = input.value.trim();
    const feedback = document.getElementById('heart-feedback');
    if (!nombre) {
        feedback.textContent = 'Escribe un nombre para la etiqueta.';
        feedback.style.color = '#dc2626';
        return;
    }
    try {
        const res = await fetch('/api/etiquetas/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ nombre }),
        });
        const data = await res.json();
        if (res.status === 201) {
            await guardarEnEtiqueta(data.id);
        } else {
            const msg = typeof data === 'object' ? Object.values(data).flat().join(' ') : 'Error al crear etiqueta.';
            feedback.textContent = msg;
            feedback.style.color = '#dc2626';
        }
    } catch {
        feedback.textContent = 'Error de conexiÃ³n.';
        feedback.style.color = '#dc2626';
    }
}

function closeHeartModal() {
    document.getElementById('heart-modal').style.display = 'none';
    currentInmuebleId = null;
}

// Event delegation for heart buttons (Leaflet popups are dynamic)
document.addEventListener('click', e => {
    const btn = e.target.closest('[data-heart]');
    if (btn) {
        e.stopPropagation();
        openHeartModal(Number(btn.dataset.heart));
    }
});
</script>

<!-- â”€â”€ Heart modal â”€â”€ -->
<div id="heart-modal"
     style="display:none;position:fixed;inset:0;z-index:9999;
            background:rgba(15,23,42,0.55);
            align-items:center;justify-content:center;
            font-family:'Inter',sans-serif">
    <div style="background:white;border-radius:20px;padding:28px;width:340px;max-width:calc(100vw - 32px);
                box-shadow:0 24px 48px -12px rgba(0,0,0,0.25);position:relative;
                display:flex;flex-direction:column;max-height:min(560px,calc(100vh - 48px));overflow:hidden">

        <!-- Header -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-shrink:0">
            <div style="display:flex;align-items:center;gap:8px">
                <span class="material-icons" style="color:#e11d48;font-size:22px">favorite</span>
                <span style="font-size:1rem;font-weight:800;color:#1e293b">Guardar en etiqueta</span>
            </div>
            <button onclick="closeHeartModal()"
                    style="background:none;border:none;cursor:pointer;color:#94a3b8;padding:4px;
                           border-radius:8px;display:flex;align-items:center;justify-content:center"
                    onmouseover="this.style.color='#334155'" onmouseout="this.style.color='#94a3b8'">
                <span class="material-icons" style="font-size:20px">close</span>
            </button>
        </div>

        <!-- Existing tags list -->
        <div id="heart-etiquetas-list"
             style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;
                    overflow-y:auto;min-height:0;flex-shrink:1;
                    scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent;padding-right:2px">
            <p style="color:#94a3b8;font-size:0.85rem;margin:0">Cargando etiquetas...</p>
        </div>

        <!-- Divider -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-shrink:0">
            <div style="flex:1;height:1px;background:#f1f5f9"></div>
            <span style="font-size:0.7rem;font-weight:700;color:#94a3b8;white-space:nowrap">o crear nueva</span>
            <div style="flex:1;height:1px;background:#f1f5f9"></div>
        </div>

        <!-- New tag input -->
        <div style="display:flex;flex-direction:column;gap:8px;flex-shrink:0">
            <input id="new-etiqueta-input" type="text" placeholder="Nombre de la etiqueta"
                   style="width:100%;box-sizing:border-box;padding:9px 14px;border:1.5px solid #e2e8f0;border-radius:10px;
                          font-family:'Inter',sans-serif;font-size:0.875rem;font-weight:500;
                          color:#334155;outline:none;transition:border-color 0.15s"
                   onfocus="this.style.borderColor='#136dec'" onblur="this.style.borderColor='#e2e8f0'"
                   onkeydown="if(event.key==='Enter') crearYGuardar()"/>
            <button onclick="crearYGuardar()"
                    style="width:100%;padding:9px 16px;background:#136dec;color:white;border:none;border-radius:10px;
                           font-family:'Inter',sans-serif;font-size:0.875rem;font-weight:700;
                           cursor:pointer;transition:background 0.15s"
                    onmouseover="this.style.background='#0f5ecf'" onmouseout="this.style.background='#136dec'">
                Crear y guardar
            </button>
        </div>

        <!-- Feedback -->
        <p id="heart-feedback" style="margin:12px 0 0;font-size:0.82rem;font-weight:600;min-height:18px;flex-shrink:0"></p>
    </div>
</div>

</body>
</html>
