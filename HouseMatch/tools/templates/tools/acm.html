{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HouseMatch | ACM</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: { "primary": "#136dec" },
                fontFamily: { "display": ["Inter", "sans-serif"] },
            },
        },
    }
</script>

<!-- marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; }

    .glass-panel {
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(19,109,236,0.12);
    }
    .smoke-particle {
        position: fixed;
        pointer-events: none;
        background: radial-gradient(circle, rgba(19,109,236,0.1) 0%, rgba(255,255,255,0) 70%);
        border-radius: 50%;
        transform: translate(-50%,-50%);
        z-index: 9999;
        animation: dissipate 1.2s ease-out forwards;
        mix-blend-mode: multiply;
    }
    @keyframes dissipate {
        0%   { opacity: 0.5; transform: translate(-50%,-50%) scale(0.5); }
        100% { opacity: 0;   transform: translate(-50%,-50%) scale(3); }
    }

    /* Leaflet overrides */
    .leaflet-popup-content-wrapper {
        padding: 0 !important;
        border-radius: 1rem !important;
        overflow: hidden;
        border: none !important;
        box-shadow: 0 20px 40px -8px rgba(0,0,0,0.18) !important;
    }
    .leaflet-popup-content { margin: 0 !important; width: 240px !important; }
    .leaflet-popup-tip { background: white !important; }
    .leaflet-container { font-family: 'Inter', sans-serif; }

    /* Markers */
    .hm-marker {
        width: 40px; height: 40px;
        background: #136dec;
        border-radius: 50%;
        border: 3px solid white;
        display: flex; align-items: center; justify-content: center;
        color: white;
        box-shadow: 0 6px 16px rgba(19,109,236,0.35);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hm-marker:hover {
        transform: scale(1.12);
        box-shadow: 0 10px 24px rgba(19,109,236,0.45);
    }
    .hm-marker.selected {
        background: #16a34a;
        border-color: #bbf7d0;
        box-shadow: 0 6px 20px rgba(22,163,74,0.45);
        border-width: 4px;
    }
    .hm-marker .marker-icon { font-size: 18px; }

    /* Report markdown */
    #report-content h2 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 1.25rem 0 0.5rem; }
    #report-content h3 { font-size: 1rem; font-weight: 600; color: #334155; margin: 1rem 0 0.4rem; }
    #report-content p { margin-bottom: 0.75rem; line-height: 1.7; color: #475569; }
    #report-content ul, #report-content ol { padding-left: 1.5rem; margin-bottom: 0.75rem; color: #475569; }
    #report-content li { margin-bottom: 0.3rem; }
    #report-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.8rem; }
    #report-content th { background: #eff6ff; color: #1d4ed8; padding: 0.5rem 0.75rem; text-align: left; font-weight: 600; border: 1px solid #dbeafe; }
    #report-content td { padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; color: #475569; }
    #report-content tr:nth-child(even) td { background: #f8fafc; }
    #report-content strong { color: #1e293b; }

    /* Spinner */
    .spinner {
        width: 36px; height: 36px;
        border: 3px solid #dbeafe;
        border-top-color: #136dec;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Layout */
    #main-layout {
        display: flex;
        height: calc(100vh - 64px);
        overflow: hidden;
    }
    #map-container {
        flex: 0 0 60%;
        position: relative;
        height: calc(100vh - 64px);
        overflow: hidden;
    }
    #map {
        width: 100%;
        height: 100%;
    }
    #side-panel {
        flex: 0 0 40%;
        overflow-y: auto;
        padding: 1.25rem;
        background: #f8fafc;
        border-left: 1px solid #e2e8f0;
    }
</style>
</head>

<body class="bg-white text-slate-800 antialiased flex flex-col">

<!-- Smoke cursor -->
<script>
    document.addEventListener('mousemove', function(e) {
        if (Math.random() > 0.85) return;
        const p = document.createElement('div');
        p.classList.add('smoke-particle');
        const s = Math.random() * 60 + 30;
        p.style.cssText = `width:${s}px;height:${s}px;left:${e.clientX}px;top:${e.clientY}px`;
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1200);
    });
</script>

<!-- ── Navbar ── -->
<nav class="bg-white border-b border-slate-100 z-50 flex-shrink-0 shadow-sm">
    <div class="max-w-[1920px] mx-auto px-4 lg:px-6 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="{% url 'home:index' %}" class="flex items-center gap-2 group">
                <img src="{% static 'home/img/Logo.png' %}" alt="HouseMatch Logo" class="h-8 w-auto">
                <span class="text-xl font-extrabold tracking-tight text-slate-900">HouseMatch</span>
            </a>
            <span class="text-slate-300">/</span>
            <a href="{% url 'tools:dashboard' %}" class="text-sm font-medium text-slate-500 hover:text-[#136dec] transition-colors">Herramientas</a>
            <span class="text-slate-300">/</span>
            <span class="text-sm font-semibold text-[#136dec]">ACM</span>
        </div>

        <div class="flex items-center gap-4">
            <a href="{% url 'home:mapa' %}" class="px-3 py-1.5 rounded-xl text-xs font-bold border border-slate-200 text-slate-600 hover:border-[#136dec] hover:text-[#136dec] transition-all">Mapa</a>
            {% if user.is_authenticated %}
            <a href="{% url 'home:logout' %}" class="text-slate-500 hover:text-slate-800 font-medium text-sm transition-colors">Salir</a>
            <div class="w-10 h-10 rounded-full bg-[#136dec] flex items-center justify-center text-white font-bold text-sm shadow-sm cursor-default select-none">
                {{ user.email|first|upper }}
            </div>
            {% else %}
            <a href="{% url 'home:login' %}" class="px-4 py-2 bg-[#136dec] text-white rounded-full font-semibold text-sm shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition-colors">
                Iniciar sesión
            </a>
            {% endif %}
        </div>
    </div>
</nav>

<!-- ── Main Layout ── -->
<div id="main-layout">

    <!-- Map -->
    <div id="map-container">
        <div id="map"></div>

        <!-- Map overlay instructions -->
        <div id="map-hint" class="absolute top-3 left-1/2 -translate-x-1/2 z-[1000] glass-panel rounded-full px-4 py-2 text-xs font-semibold text-slate-600 shadow-md pointer-events-none">
            <span class="material-icons text-[#136dec] text-sm align-middle mr-1">touch_app</span>
            Haz clic en los marcadores para seleccionar comparables
        </div>
    </div>

    <!-- Side Panel -->
    <div id="side-panel">

        <!-- Header -->
        <div class="mb-4">
            <h1 class="text-xl font-bold text-slate-900 mb-1">Análisis de Mercado Comparativo</h1>
            <p class="text-sm text-slate-500">Selecciona 2-3 propiedades comparables en el mapa y completa los datos del inmueble sujeto.</p>
        </div>

        <!-- Comparables section -->
        <div class="glass-panel rounded-2xl p-4 mb-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Comparables</h2>
                <span id="comp-counter" class="text-xs font-bold text-[#136dec] bg-blue-50 px-2 py-0.5 rounded-full">0/3 seleccionados</span>
            </div>
            <div id="comparables-list" class="space-y-2">
                <!-- Placeholder slots -->
                <div class="comp-placeholder flex items-center gap-3 p-2.5 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs">
                    <span class="material-icons text-slate-300 text-lg">add_location</span>
                    Selecciona una propiedad en el mapa
                </div>
                <div class="comp-placeholder flex items-center gap-3 p-2.5 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs">
                    <span class="material-icons text-slate-300 text-lg">add_location</span>
                    Selecciona una propiedad en el mapa
                </div>
                <div class="comp-placeholder flex items-center gap-3 p-2.5 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs">
                    <span class="material-icons text-slate-300 text-lg">add_location</span>
                    Opcional: tercera propiedad
                </div>
            </div>
        </div>

        <!-- Subject property form -->
        <div class="glass-panel rounded-2xl p-4 mb-4 shadow-sm">
            <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-3">Inmueble Sujeto</h2>
            <form id="sujeto-form" class="space-y-3">

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Tipo de propiedad</label>
                        <select name="tipo_propiedad" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none">
                            <option>Casa</option>
                            <option>Departamento</option>
                            <option>Quinta</option>
                            <option>Oficina</option>
                            <option>Terreno</option>
                            <option>Local</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Transacción</label>
                        <select name="tipo_transaccion" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none">
                            <option>Venta</option>
                            <option>Alquiler</option>
                            <option>Anticretico</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Zona</label>
                        <input type="text" name="zona" placeholder="Ej: Equipetrol" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Ciudad</label>
                        <input type="text" name="ciudad" value="Santa Cruz" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Área construida (m²)</label>
                        <input type="number" name="area_construida" min="0" placeholder="200" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Área terreno (m²)</label>
                        <input type="number" name="area_terreno" min="0" placeholder="300" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Habitaciones</label>
                        <input type="number" name="cant_cuartos" min="0" placeholder="3" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Baños</label>
                        <input type="number" name="cant_banios" min="0" placeholder="2" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-2">Estado de conservación</label>
                    <select name="estado_conservacion" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none">
                        <option>Excelente</option>
                        <option>Bueno</option>
                        <option>Regular</option>
                        <option>A remodelar</option>
                    </select>
                </div>

                <div class="flex items-center gap-5">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="parqueo" class="w-4 h-4 rounded accent-[#136dec]"/>
                        <span class="text-sm text-slate-600">Parqueo</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="piscina" class="w-4 h-4 rounded accent-[#136dec]"/>
                        <span class="text-sm text-slate-600">Piscina</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="mascotas" class="w-4 h-4 rounded accent-[#136dec]"/>
                        <span class="text-sm text-slate-600">Mascotas</span>
                    </label>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Precio del propietario (USD) <span class="font-normal text-slate-400">— opcional</span></label>
                    <input type="number" name="precio_propietario_usd" min="0" placeholder="150000" class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none"/>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Notas adicionales <span class="font-normal text-slate-400">— opcional</span></label>
                    <textarea name="notas" rows="2" placeholder="Ej: Propiedad en esquina, vista al parque..." class="w-full text-sm rounded-lg border border-slate-200 bg-white px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-[#136dec] outline-none resize-none"></textarea>
                </div>

            </form>
        </div>

        <!-- Generate button -->
        <button id="btn-generar"
                onclick="generateACM()"
                disabled
                class="w-full py-3 bg-[#136dec] text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition-colors disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2">
            <span class="material-icons text-base">auto_awesome</span>
            Generar ACM con IA
        </button>

        <p class="text-center text-xs text-slate-400 mt-2" id="btn-hint">Selecciona al menos 2 comparables para continuar</p>

    </div>
</div>

<!-- ── Report Section (hidden initially) ── -->
<div id="report-section" class="hidden bg-white border-t border-slate-100">
    <div class="max-w-4xl mx-auto px-6 py-10">

        <!-- Spinner -->
        <div id="report-spinner" class="hidden flex flex-col items-center gap-4 py-12">
            <div class="spinner"></div>
            <p class="text-sm text-slate-500 font-medium">Generando análisis con IA...</p>
        </div>

        <!-- Error -->
        <div id="report-error" class="hidden bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
            <span class="material-icons text-red-400 text-3xl mb-2 block">error_outline</span>
            <p id="report-error-text" class="text-sm text-red-600 font-medium"></p>
        </div>

        <!-- Report content -->
        <div id="report-result" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-[#136dec] flex items-center justify-center">
                        <span class="material-icons text-white text-lg">analytics</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Análisis de Mercado Comparativo</h2>
                        <p class="text-xs text-slate-400">Generado por IA · HouseMatch</p>
                    </div>
                </div>
                <button onclick="resetACM()" class="flex items-center gap-1.5 px-4 py-2 rounded-xl border border-slate-200 text-sm font-semibold text-slate-600 hover:border-[#136dec] hover:text-[#136dec] transition-all">
                    <span class="material-icons text-sm">refresh</span>
                    Nueva consulta
                </button>
            </div>

            <div id="report-content" class="glass-panel rounded-2xl p-8 shadow-sm leading-relaxed text-sm"></div>
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ── State ──
const selectedComparables = [];  // array of GeoJSON feature objects
const markerRegistry = new Map(); // id → {feature, marker, element}

// ── Map init ──
const mapInst = L.map('map', {
    center: [-17.78, -63.18],
    zoom: 13,
    zoomControl: true,
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a>',
    maxZoom: 19,
}).addTo(mapInst);

const clusterGroup = L.markerClusterGroup({ maxClusterRadius: 50 });
mapInst.addLayer(clusterGroup);
setTimeout(() => mapInst.invalidateSize(), 0);
window.addEventListener('load', () => mapInst.invalidateSize());

// ── Marker icon factory ──
function createMarkerIcon(isSelected) {
    const cls = 'hm-marker' + (isSelected ? ' selected' : '');
    const icon = isSelected ? 'check' : 'home';
    return L.divIcon({
        html: `<div class="${cls}"><span class="material-icons marker-icon">${icon}</span></div>`,
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
}

// ── Toggle selection ──
function toggleComparable(feature, marker) {
    const id = feature.properties.id;

    if (markerRegistry.get(id)?.selected) {
        // Deselect
        const idx = selectedComparables.findIndex(f => f.properties.id === id);
        if (idx !== -1) selectedComparables.splice(idx, 1);
        markerRegistry.set(id, { ...markerRegistry.get(id), selected: false });
        marker.setIcon(createMarkerIcon(false));
    } else {
        if (selectedComparables.length >= 3) {
            showMapToast('Máximo 3 comparables permitidos');
            return;
        }
        // Select
        selectedComparables.push(feature);
        markerRegistry.set(id, { ...markerRegistry.get(id), selected: true });
        marker.setIcon(createMarkerIcon(true));
    }

    updateComparablesList();
    updateGenerateButton();
}

// ── Load properties from API ──
const hintEl = document.getElementById('map-hint');

fetch('/api/inmuebles/mapa/')
    .then(r => r.json())
    .then(data => {
        const features = data.features || [];
        features.forEach(feature => {
            const p = feature.properties;
            const [lng, lat] = feature.geometry.coordinates;

            const marker = L.marker([lat, lng], { icon: createMarkerIcon(false) });

            markerRegistry.set(p.id, { feature, marker, selected: false });

            marker.on('click', () => toggleComparable(feature, marker));

            marker.bindPopup(() => {
                const img = p.imagen_principal
                    ? `<img src="${p.imagen_principal}" class="w-full h-28 object-cover" />`
                    : `<div class="w-full h-16 bg-slate-100 flex items-center justify-center text-slate-300"><span class="material-icons text-3xl">home</span></div>`;
                const precio = p.precio_usd ? `$${Number(p.precio_usd).toLocaleString()} USD` : 'Precio no especificado';
                return `<div>
                    ${img}
                    <div class="p-3">
                        <p class="font-bold text-slate-900 text-sm leading-snug mb-1">${p.titulo || 'Sin título'}</p>
                        <p class="text-xs text-slate-500 mb-1">${p.zona || ''}, ${p.ciudad || ''}</p>
                        <p class="text-sm font-bold text-[#136dec]">${precio}</p>
                        <button onclick="selectFromPopup(${p.id})" class="mt-2 w-full py-1.5 bg-[#136dec] text-white rounded-lg text-xs font-bold hover:bg-blue-600 transition-colors">
                            Seleccionar como comparable
                        </button>
                    </div>
                </div>`;
            }, { maxWidth: 240 });

            clusterGroup.addLayer(marker);
        });

        setTimeout(() => mapInst.invalidateSize(), 50);
        if (features.length > 0 && clusterGroup.getLayers().length > 0) {
            mapInst.fitBounds(clusterGroup.getBounds().pad(0.08));
        }

        if (features.length === 0) {
            hintEl.innerHTML = `<span class="material-icons text-amber-500 text-sm align-middle mr-1">warning</span>
                No hay propiedades disponibles en el mapa`;
        } else {
            hintEl.innerHTML = `<span class="material-icons text-[#136dec] text-sm align-middle mr-1">touch_app</span>
                ${features.length} propiedades · Haz clic para seleccionar comparables`;
        }
    })
    .catch(err => {
        console.error('Error cargando inmuebles:', err);
        hintEl.innerHTML =
            `<span class="material-icons text-red-500 text-sm align-middle mr-1">error</span>
             Error al cargar propiedades`;
    });

// ── Select from popup ──
function selectFromPopup(id) {
    const reg = markerRegistry.get(id);
    if (!reg) return;
    mapInst.closePopup();
    toggleComparable(reg.feature, reg.marker);
}

// ── Update comparables list in panel ──
function updateComparablesList() {
    const container = document.getElementById('comparables-list');
    const counter = document.getElementById('comp-counter');

    container.innerHTML = '';

    // Show selected cards
    selectedComparables.forEach((feature, idx) => {
        const p = feature.properties;
        const precio = p.precio_usd ? `$${Number(p.precio_usd).toLocaleString()} USD` : '—';
        const card = document.createElement('div');
        card.className = 'flex items-start gap-3 p-2.5 rounded-xl border border-green-200 bg-green-50';
        card.innerHTML = `
            <div class="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center flex-shrink-0 text-white text-xs font-bold">${idx + 1}</div>
            <div class="flex-1 min-w-0">
                <p class="text-xs font-semibold text-slate-800 truncate">${p.titulo || 'Sin título'}</p>
                <p class="text-[11px] text-slate-500 truncate">${p.zona || ''}, ${p.ciudad || ''}</p>
                <p class="text-xs font-bold text-green-700">${precio}</p>
            </div>
            <button onclick="removeComparable(${p.id})" class="flex-shrink-0 text-slate-400 hover:text-red-500 transition-colors p-1">
                <span class="material-icons text-sm">close</span>
            </button>`;
        container.appendChild(card);
    });

    // Fill remaining placeholders
    const remaining = 3 - selectedComparables.length;
    for (let i = 0; i < remaining; i++) {
        const placeholder = document.createElement('div');
        placeholder.className = 'comp-placeholder flex items-center gap-3 p-2.5 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs';
        const isOptional = selectedComparables.length >= 2 && i === 0;
        placeholder.innerHTML = `<span class="material-icons text-slate-300 text-lg">add_location</span>${isOptional ? 'Opcional: tercera propiedad' : 'Selecciona una propiedad en el mapa'}`;
        container.appendChild(placeholder);
    }

    counter.textContent = `${selectedComparables.length}/3 seleccionados`;
}

function removeComparable(id) {
    const reg = markerRegistry.get(id);
    if (!reg) return;
    const idx = selectedComparables.findIndex(f => f.properties.id === id);
    if (idx !== -1) selectedComparables.splice(idx, 1);
    markerRegistry.set(id, { ...reg, selected: false });
    reg.marker.setIcon(createMarkerIcon(false));
    updateComparablesList();
    updateGenerateButton();
}

function updateGenerateButton() {
    const btn = document.getElementById('btn-generar');
    const hint = document.getElementById('btn-hint');
    const canGenerate = selectedComparables.length >= 2;
    btn.disabled = !canGenerate;
    hint.textContent = canGenerate
        ? `${selectedComparables.length} comparable${selectedComparables.length > 1 ? 's' : ''} seleccionado${selectedComparables.length > 1 ? 's' : ''} · Listo para generar`
        : 'Selecciona al menos 2 comparables para continuar';
    hint.className = canGenerate
        ? 'text-center text-xs text-green-600 font-medium mt-2'
        : 'text-center text-xs text-slate-400 mt-2';
}

// ── Toast ──
function showMapToast(msg) {
    const toast = document.createElement('div');
    toast.className = 'absolute bottom-4 left-1/2 -translate-x-1/2 z-[2000] glass-panel rounded-full px-4 py-2 text-xs font-semibold text-slate-700 shadow-lg pointer-events-none';
    toast.textContent = msg;
    document.getElementById('map-container').appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

// ── CSRF ──
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        for (const cookie of document.cookie.split(';')) {
            const c = cookie.trim();
            if (c.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(c.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ── Generate ACM ──
async function generateACM() {
    const form = document.getElementById('sujeto-form');
    const sujeto = Object.fromEntries(new FormData(form));
    sujeto.parqueo = document.getElementById('parqueo').checked;
    sujeto.piscina = document.getElementById('piscina').checked;
    sujeto.permite_mascotas = document.getElementById('mascotas').checked;

    const body = {
        comparables: selectedComparables.map(f => f.properties),
        sujeto,
    };

    // Show report section + spinner
    const reportSection = document.getElementById('report-section');
    reportSection.classList.remove('hidden');
    document.getElementById('report-spinner').classList.remove('hidden');
    document.getElementById('report-error').classList.add('hidden');
    document.getElementById('report-result').classList.add('hidden');
    document.getElementById('btn-generar').disabled = true;

    reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    try {
        const resp = await fetch('/tools/acm/api/generar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(body),
        });
        const data = await resp.json();

        document.getElementById('report-spinner').classList.add('hidden');

        if (data.ok) {
            document.getElementById('report-content').innerHTML = marked.parse(data.reporte);
            document.getElementById('report-result').classList.remove('hidden');
        } else {
            document.getElementById('report-error-text').textContent = data.error || 'Error desconocido';
            document.getElementById('report-error').classList.remove('hidden');
        }
    } catch (err) {
        document.getElementById('report-spinner').classList.add('hidden');
        document.getElementById('report-error-text').textContent = 'Error de conexión: ' + err.message;
        document.getElementById('report-error').classList.remove('hidden');
    } finally {
        updateGenerateButton();
    }
}

// ── Reset ──
function resetACM() {
    document.getElementById('report-section').classList.add('hidden');
    document.getElementById('report-content').innerHTML = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

</body>
</html>
