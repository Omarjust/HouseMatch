{% extends "base.html" %}
{% block nav_mapa %}active{% endblock %}
{% block page_title %}Mapa de Inmuebles{% endblock %}
{% block title %}CMA ¬∑ Datos de la Propiedad{% endblock %}

{% block extra_css %}
<style>
  .card-comparable {
    border: 1px solid #D1D5DB;
    border-radius: 10px;
    padding: 1rem;
    background: #F5F7FA;
    height: 100%;
  }
  .card-comparable h6 { color: #1E3A5F; font-weight: 700; }
  .card-comparable .precio { color: #27AE60; font-weight: 700; font-size: 15px; }

  .rating-group { display: flex; gap: 6px; }
  .rating-group input[type=radio] { display: none; }
  .rating-group label {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-weight: 700; font-size: 14px;
    border: 2px solid #D1D5DB; color: #6B7280;
    transition: all 0.15s;
  }
  .rating-group input[type=radio]:checked + label {
    background: #1E3A5F; border-color: #1E3A5F; color: white;
  }
  .rating-group label:hover { border-color: #2E86AB; color: #2E86AB; }

  .rating-legend { display: flex; justify-content: space-between; font-size: 11px; color: #9CA3AF; margin-top: 4px; }

  .step-indicator {
    display: flex; align-items: center; gap: 8px; margin-bottom: 1.5rem;
  }
  .step-indicator .step {
    display: flex; align-items: center; justify-content: center;
    width: 30px; height: 30px; border-radius: 50%;
    font-weight: 700; font-size: 13px;
  }
  .step-indicator .step.done { background: #27AE60; color: white; }
  .step-indicator .step.active { background: #1E3A5F; color: white; }
  .step-indicator .step.pending { background: #E5E7EB; color: #9CA3AF; }
  .step-indicator .line { flex: 1; height: 2px; background: #E5E7EB; }
  .step-indicator .line.done { background: #27AE60; }

  .img-comparable {
    width: 100%; height: 110px; object-fit: cover;
    border-radius: 8px; margin-bottom: 8px;
  }
  .img-placeholder {
    width: 100%; height: 110px; background: #E5E7EB;
    border-radius: 8px; display: flex; align-items: center;
    justify-content: center; color: #9CA3AF; margin-bottom: 8px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 960px;">

  <!-- Indicador de pasos -->
  <div class="step-indicator">
    <div class="step done">‚úì</div>
    <div class="line done"></div>
    <div class="step active">2</div>
    <div class="line"></div>
    <div class="step pending">3</div>
    <span class="ms-2 text-muted small">Comparables ‚Üí Datos objetivo ‚Üí Informe</span>
  </div>

  <h4 class="fw-bold text-primary mb-1">Paso 2 ‚Äî Datos de la Propiedad a Valuar</h4>
  <p class="text-muted mb-4">Completa los datos del inmueble objetivo y califica el estado de cada comparable.</p>

  {% if error %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
  </div>
  {% endif %}

  <form method="POST" action="{% url 'cma:procesar' %}">
    {% csrf_token %}
    <!-- IDs de comparables (hidden) -->
    <input type="hidden" name="comp_1" value="{{ comparables.0.pk }}">
    <input type="hidden" name="comp_2" value="{{ comparables.1.pk }}">
    <input type="hidden" name="comp_3" value="{{ comparables.2.pk }}">

    <!-- ‚îÄ‚îÄ CALIFICAR ANTIG√úEDAD DE COMPARABLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0 fw-bold text-primary">
          <i class="bi bi-star me-2"></i>Estado de conservaci√≥n de las comparables
        </h5>
        <p class="text-muted small mb-0">Eval√∫a el estado de cada propiedad comparable (1 = deteriorado, 5 = nuevo/remodelado).</p>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for comp in comparables %}
          <div class="col-md-4">
            <div class="card-comparable">
              {% if comp.imagen_principal %}
                <img src="{{ comp.imagen_principal }}" class="img-comparable" alt="{{ comp.titulo }}">
              {% else %}
                <div class="img-placeholder"><i class="bi bi-house fs-3"></i></div>
              {% endif %}
              <h6>{{ comp.titulo|truncatechars:40 }}</h6>
              <div class="precio mb-1">${{ comp.precio_usd|floatformat:0 }} USD</div>
              <div class="text-muted small mb-2">
                üõè {{ comp.cant_cuartos }} &nbsp; üöø {{ comp.cant_banios }} &nbsp; üìê {{ comp.area_construida }} m¬≤
                {% if comp.parqueo %}&nbsp;üöó{% endif %}
                {% if comp.piscina %}&nbsp;üèä{% endif %}
              </div>
              <div class="small text-muted mb-1 fw-semibold">Antig√ºedad / Estado:</div>
              <div class="rating-group" id="rating-{{ forloop.counter }}">
                {% for val in "12345" %}
                <input type="radio" name="antiguedad_{{ forloop.parentloop.counter }}" 
                       id="r{{ forloop.parentloop.counter }}_{{ val }}" value="{{ val }}"
                       {% if val == "3" %}checked{% endif %}>
                <label for="r{{ forloop.parentloop.counter }}_{{ val }}">{{ val }}</label>
                {% endfor %}
              </div>
              <div class="rating-legend">
                <span>Deteriorado</span><span>Nuevo</span>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ DATOS DE LA PROPIEDAD OBJETIVO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0 fw-bold text-primary">
          <i class="bi bi-house-add me-2"></i>Propiedad Objetivo
        </h5>
        <p class="text-muted small mb-0">Ingresa las caracter√≠sticas del inmueble a valuar.</p>
      </div>
      <div class="card-body">
        <div class="row g-3">

          <div class="col-md-12">
            <label class="form-label fw-semibold">T√≠tulo / Referencia</label>
            <input type="text" name="titulo" class="form-control" 
                   placeholder="Ej: Apartamento en Miraflores" value="Propiedad a valuar">
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Cuartos <span class="text-danger">*</span></label>
            <input type="number" name="cant_cuartos" class="form-control" min="1" max="20" value="3" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Ba√±os <span class="text-danger">*</span></label>
            <input type="number" name="cant_banios" class="form-control" min="1" max="15" value="2" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">√Årea construida (m¬≤) <span class="text-danger">*</span></label>
            <input type="number" name="area_construida" class="form-control" step="0.01" min="1" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">√Årea terreno (m¬≤) <span class="text-danger">*</span></label>
            <input type="number" name="area_terreno" class="form-control" step="0.01" min="1" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Zona</label>
            <input type="text" name="zona" class="form-control" placeholder="Ej: Sopocachi">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Ciudad</label>
            <input type="text" name="ciudad" class="form-control" placeholder="Ej: La Paz">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold d-block">Servicios</label>
            <div class="form-check form-check-inline mt-1">
              <input class="form-check-input" type="checkbox" name="parqueo" id="parqueo">
              <label class="form-check-label" for="parqueo">üöó Estacionamiento</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="piscina" id="piscina">
              <label class="form-check-label" for="piscina">üèä Piscina</label>
            </div>
          </div>

          <div class="col-md-12">
            <label class="form-label fw-semibold">
              Estado de conservaci√≥n de la propiedad objetivo (1-5)
            </label>
            <div class="rating-group" id="rating-objetivo">
              {% for val in "12345" %}
              <input type="radio" name="antiguedad_objetivo" 
                     id="ro_{{ val }}" value="{{ val }}"
                     {% if val == "3" %}checked{% endif %}>
              <label for="ro_{{ val }}">{{ val }}</label>
              {% endfor %}
            </div>
            <div class="rating-legend" style="max-width: 200px;">
              <span>Deteriorado</span><span>Nuevo</span>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Contexto adicional (opcional)</label>
            <textarea name="contexto" class="form-control" rows="2"
              placeholder="Observaciones del agente: tipo de mercado, caracter√≠sticas especiales, etc."></textarea>
          </div>

        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="d-flex justify-content-between">
      <a href="{% url 'cma:mapa' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Volver al mapa
      </a>
      <button type="submit" class="btn btn-primary px-4" id="btn-generar">
        <i class="bi bi-cpu me-2"></i>Generar An√°lisis con IA
      </button>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.querySelector('form').addEventListener('submit', function() {
    const btn = document.getElementById('btn-generar');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Analizando con IA‚Ä¶`;
  });
</script>
{% endblock %}