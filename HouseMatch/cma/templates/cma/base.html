{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>{% block title %}HouseMatch{% endblock %}</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary":          "#136dec",
            "primary-dark":     "#0f55c0",
            "background-light": "#ffffff",
            "background-dark":  "#f8fafc",
            "text-main":        "#1e293b",
            "text-muted":       "#64748b",
          },
          fontFamily: { "display": ["Inter", "sans-serif"] },
          borderRadius: {
            DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem",
            "2xl": "1rem", full: "9999px"
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    /* ── Glass panel ─────────────────────────────────────────── */
    .glass-panel {
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(19,109,236,0.12);
    }

    /* ── Smoke cursor ────────────────────────────────────────── */
    .smoke-particle {
      position: fixed;
      pointer-events: none;
      background: radial-gradient(circle, rgba(19,109,236,0.1) 0%, rgba(255,255,255,0) 70%);
      border-radius: 50%;
      transform: translate(-50%,-50%);
      z-index: 9999;
      animation: dissipate 1.2s ease-out forwards;
      mix-blend-mode: multiply;
    }
    @keyframes dissipate {
      0%   { opacity:.5; transform:translate(-50%,-50%) scale(.5); }
      100% { opacity:0;  transform:translate(-50%,-50%) scale(3); }
    }

    /* ── Sidebar nav item ────────────────────────────────────── */
    .nav-item {
      @apply flex items-center gap-3 px-4 py-2.5 rounded-xl text-slate-500
             font-semibold text-sm transition-all duration-150
             hover:bg-primary/8 hover:text-primary;
    }
    .nav-item.active {
      @apply bg-primary/10 text-primary;
    }
    .nav-item .material-icons,
    .nav-item .material-symbols-outlined {
      @apply text-xl;
    }

    /* ── Sidebar collapse animation ──────────────────────────── */
    #sidebar { transition: width 0.25s ease; }
    #sidebar.collapsed { width: 4.5rem !important; }
    #sidebar.collapsed .sidebar-label { display: none; }
    #sidebar.collapsed .sidebar-logo-text { display: none; }
    #sidebar.collapsed .nav-item { justify-content: center; padding: 0.625rem; }
    #sidebar.collapsed .sidebar-section-label { display: none; }
    #sidebar.collapsed .user-info { display: none; }

    /* ── Page fade-in ────────────────────────────────────────── */
    @keyframes fadeUp {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .page-content { animation: fadeUp .35s ease both; }

    /* ── Toast ───────────────────────────────────────────────── */
    #toast-container { pointer-events: none; }
  </style>

  {% block extra_css %}{% endblock %}
</head>

<body class="bg-background-dark text-text-main font-display antialiased h-screen flex overflow-hidden selection:bg-primary selection:text-white">

<!-- ── Smoke cursor effect ─────────────────────────────────────────────── -->
<script>
  document.addEventListener('mousemove', function(e) {
    if (Math.random() > 0.85) return;
    const p = document.createElement('div');
    p.classList.add('smoke-particle');
    const s = Math.random() * 60 + 30;
    p.style.cssText = `width:${s}px;height:${s}px;left:${e.clientX}px;top:${e.clientY}px`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1200);
  });
</script>

<!-- ════════════════════════════════════════════════════════════════════════
     SIDEBAR
════════════════════════════════════════════════════════════════════════ -->
<aside id="sidebar"
       class="w-60 min-h-screen bg-white border-r border-slate-100 flex flex-col z-50 shrink-0 shadow-[1px_0_0_0_rgba(0,0,0,0.04)]">

  <!-- Logo -->
  <div class="h-16 flex items-center px-5 border-b border-slate-100 gap-3 shrink-0">
    <div class="w-9 h-9 rounded-xl bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/20 shrink-0">
      <span class="material-icons text-xl">home</span>
    </div>
    <span class="sidebar-logo-text text-xl font-extrabold tracking-tight text-slate-900">HouseMatch</span>
    <!-- Collapse button -->
    <button onclick="toggleSidebar()"
            class="ml-auto text-slate-400 hover:text-primary transition-colors p-1 rounded-lg hover:bg-slate-50"
            title="Colapsar menú">
      <span class="material-symbols-outlined text-xl" id="sidebar-toggle-icon">menu_open</span>
    </button>
  </div>

  <!-- Nav links -->
  <nav class="flex-1 py-4 px-3 flex flex-col gap-1 overflow-y-auto">

    <p class="sidebar-section-label px-3 mb-1 text-[10px] font-black text-slate-400 uppercase tracking-widest">Explorar</p>

    <a href="{% url 'home:mapa' %}"
       class="nav-item {% block nav_mapa %}{% endblock %}">
      <span class="material-symbols-outlined">map</span>
      <span class="sidebar-label">Mapa de Inmuebles</span>
    </a>

    <a href="{% url 'home:etiquetas' %}"
       class="nav-item {% block nav_etiquetas %}{% endblock %}">
      <span class="material-symbols-outlined">bookmark</span>
      <span class="sidebar-label">Mis Etiquetas</span>
    </a>

    <div class="my-2 border-t border-slate-100"></div>
    <p class="sidebar-section-label px-3 mb-1 text-[10px] font-black text-slate-400 uppercase tracking-widest">Análisis</p>

    <a href="{% url 'cma:mapa' %}"
       class="nav-item {% block nav_cma_nuevo %}{% endblock %}">
      <span class="material-symbols-outlined">add_chart</span>
      <span class="sidebar-label">Nuevo CMA</span>
    </a>

    <a href="{% url 'cma:historial' %}"
       class="nav-item {% block nav_cma_historial %}{% endblock %}">
      <span class="material-symbols-outlined">history</span>
      <span class="sidebar-label">Historial CMA</span>
    </a>

    <div class="my-2 border-t border-slate-100"></div>
    <p class="sidebar-section-label px-3 mb-1 text-[10px] font-black text-slate-400 uppercase tracking-widest">Cuenta</p>

    <a href="{% url 'home:index' %}"
       class="nav-item {% block nav_inicio %}{% endblock %}">
      <span class="material-symbols-outlined">dashboard</span>
      <span class="sidebar-label">Inicio</span>
    </a>

    <a href="{% url 'home:pricing' %}"
       class="nav-item {% block nav_pricing %}{% endblock %}">
      <span class="material-symbols-outlined">workspace_premium</span>
      <span class="sidebar-label">Planes</span>
    </a>

  </nav>

  <!-- User card -->
  {% if user.is_authenticated %}
  <div class="border-t border-slate-100 p-4 shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
        <span class="material-icons text-primary text-lg">person</span>
      </div>
      <div class="user-info flex-1 min-w-0">
        <p class="text-sm font-bold text-slate-800 truncate">{{ user.email }}</p>
        <p class="text-xs text-slate-400 truncate">
          {% if user.plan_activo %}
            <span class="text-green-500 font-semibold">● Plan activo</span>
          {% else %}
            <span class="text-red-400 font-semibold">● Sin plan activo</span>
          {% endif %}
        </p>
      </div>
      <a href="{% url 'home:logout' %}"
         class="text-slate-400 hover:text-red-400 transition-colors p-1 rounded-lg hover:bg-red-50"
         title="Cerrar sesión">
        <span class="material-symbols-outlined text-xl">logout</span>
      </a>
    </div>
  </div>
  {% endif %}

</aside>


<!-- ════════════════════════════════════════════════════════════════════════
     MAIN WRAPPER
════════════════════════════════════════════════════════════════════════ -->
<div class="flex-1 flex flex-col min-w-0 overflow-hidden">

  <!-- ── Top navbar ──────────────────────────────────────────────────── -->
  <nav class="h-16 bg-white border-b border-slate-100 z-40 flex items-center px-6 gap-4 shrink-0 shadow-[0_1px_3px_rgba(0,0,0,0.02)]">

    <!-- Page title -->
    <div class="flex-1">
      <h1 class="text-base font-extrabold text-slate-900 tracking-tight">
        {% block page_title %}HouseMatch{% endblock %}
      </h1>
      {% block page_subtitle %}{% endblock %}
    </div>

    <!-- Search bar (opcional, páginas pueden ocultarla) -->
    {% block navbar_search %}{% endblock %}

    <!-- Right actions -->
    <div class="flex items-center gap-3">

      <!-- Notifications -->
      <button class="relative text-slate-400 hover:text-primary transition-colors p-2 rounded-xl hover:bg-slate-50">
        <span class="material-icons">notifications</span>
        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-primary rounded-full border-2 border-white"></span>
      </button>

      <!-- Extra navbar buttons slot -->
      {% block navbar_actions %}{% endblock %}

      <!-- Avatar -->
      {% if user.is_authenticated %}
      <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center ring-2 ring-primary/20 cursor-pointer">
        <span class="material-icons text-primary text-lg">person</span>
      </div>
      {% else %}
      <a href="{% url 'home:login' %}"
         class="px-5 py-2 bg-primary text-white text-sm font-bold rounded-2xl shadow-lg shadow-primary/20 hover:shadow-primary/30 hover:scale-[1.02] transition-all">
        Ingresar
      </a>
      {% endif %}
    </div>

  </nav>

  <!-- ── Flash messages ──────────────────────────────────────────────── -->
  {% if messages %}
  <div class="px-6 pt-4 flex flex-col gap-2 z-30">
    {% for message in messages %}
    <div class="flex items-center gap-3 px-5 py-3 rounded-2xl text-sm font-semibold shadow-sm border
      {% if message.tags == 'error' %}bg-red-50 text-red-700 border-red-100
      {% elif message.tags == 'success' %}bg-green-50 text-green-700 border-green-100
      {% elif message.tags == 'warning' %}bg-amber-50 text-amber-700 border-amber-100
      {% else %}bg-blue-50 text-primary border-blue-100{% endif %}">
      <span class="material-symbols-outlined text-lg">
        {% if message.tags == 'error' %}error
        {% elif message.tags == 'success' %}check_circle
        {% elif message.tags == 'warning' %}warning
        {% else %}info{% endif %}
      </span>
      {{ message }}
      <button onclick="this.parentElement.remove()" class="ml-auto opacity-60 hover:opacity-100 transition-opacity">
        <span class="material-symbols-outlined text-base">close</span>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ── Page content ────────────────────────────────────────────────── -->
  <main class="flex-1 overflow-auto page-content">
    {% block content %}{% endblock %}
  </main>

</div><!-- end main wrapper -->


<!-- ── Toast container (para notificaciones JS) ───────────────────────── -->
<div id="toast-container" class="fixed bottom-6 right-6 z-[9998] flex flex-col gap-2"></div>


<!-- ════════════════════════════════════════════════════════════════════════
     GLOBAL JS
════════════════════════════════════════════════════════════════════════ -->
<script>
  // ── Sidebar collapse ──────────────────────────────────────────────────
  function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    const icon = document.getElementById('sidebar-toggle-icon');
    sb.classList.toggle('collapsed');
    icon.textContent = sb.classList.contains('collapsed') ? 'menu' : 'menu_open';
    localStorage.setItem('sidebarCollapsed', sb.classList.contains('collapsed'));
  }
  // Restore state
  if (localStorage.getItem('sidebarCollapsed') === 'true') {
    document.getElementById('sidebar').classList.add('collapsed');
    document.getElementById('sidebar-toggle-icon').textContent = 'menu';
  }

  // ── Toast helper ──────────────────────────────────────────────────────
  function showToast(msg, type = 'info', duration = 4000) {
    const colors = {
      info:    'bg-blue-50 text-primary border-blue-100',
      success: 'bg-green-50 text-green-700 border-green-100',
      error:   'bg-red-50 text-red-700 border-red-100',
      warning: 'bg-amber-50 text-amber-700 border-amber-100',
    };
    const icons = { info:'info', success:'check_circle', error:'error', warning:'warning' };
    const toast = document.createElement('div');
    toast.className = `flex items-center gap-3 px-5 py-3 rounded-2xl text-sm font-semibold shadow-xl border pointer-events-auto
      transition-all duration-300 translate-y-4 opacity-0 ${colors[type] || colors.info}`;
    toast.innerHTML = `
      <span class="material-symbols-outlined text-lg">${icons[type] || 'info'}</span>
      <span>${msg}</span>
      <button onclick="this.parentElement.remove()" class="ml-auto opacity-60 hover:opacity-100 transition-opacity">
        <span class="material-symbols-outlined text-base">close</span>
      </button>`;
    document.getElementById('toast-container').appendChild(toast);
    requestAnimationFrame(() => {
      toast.classList.remove('translate-y-4', 'opacity-0');
    });
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-y-4');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
</script>

{% block extra_js %}{% endblock %}

</body>
</html>